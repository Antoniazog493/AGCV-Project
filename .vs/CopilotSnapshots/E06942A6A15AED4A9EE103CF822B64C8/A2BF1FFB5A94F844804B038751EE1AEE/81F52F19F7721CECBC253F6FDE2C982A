using capaNegocio;
using System;
using System.Windows.Forms;

namespace AGCV
{
    public partial class Historial : Form
    {
        private readonly CNHistorial _cnHistorial = new CNHistorial();

        public Historial()
        {
            InitializeComponent();
        }

        private void Historial_Load(object sender, EventArgs e)
        {
            try
            {
                // Personalizar bienvenida
                lblBienvenida.Text = $"👤 Bienvenido, {SesionActual.NombreUsuario}";
                
                int idUsuario = SesionActual.IdUsuario;

                // Cargar datos del historial
                var datos = _cnHistorial.ObtenerHistorial(idUsuario);

                if (datos != null && datos.Tables.Count > 0 && datos.Tables["Historial"] != null)
                {
                    var tabla = datos.Tables["Historial"];
                    dataGridView1.DataSource = tabla;

                    // Actualizar contador de registros
                    lblRegistros.Text = $"📋 Registros: {tabla.Rows.Count}";

                    // Aplicar estilos al DataGridView
                    EstilizarDataGridView();
                }
                else
                {
                    lblRegistros.Text = "📋 Registros: 0";
                    MessageBox.Show("No hay registros en el historial", "Información",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al cargar el historial:\n{ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void EstilizarDataGridView()
        {
            try
            {
                // Configurar apariencia
                dataGridView1.EnableHeadersVisualStyles = false;
                dataGridView1.ColumnHeadersDefaultCellStyle.BackColor = Color.FromArgb(52, 73, 94);
                dataGridView1.ColumnHeadersDefaultCellStyle.ForeColor = Color.White;
                dataGridView1.ColumnHeadersDefaultCellStyle.Font = new System.Drawing.Font("Segoe UI", 11, System.Drawing.FontStyle.Bold);
                dataGridView1.ColumnHeadersDefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter;

                // Alternar colores de filas
                dataGridView1.RowsDefaultCellStyle.BackColor = Color.White;
                dataGridView1.AlternatingRowsDefaultCellStyle.BackColor = Color.FromArgb(236, 240, 241);
                dataGridView1.RowsDefaultCellStyle.Font = new System.Drawing.Font("Segoe UI", 10);

                // Altura de filas
                dataGridView1.RowTemplate.Height = 30;

                // Alineación
                dataGridView1.ColumnHeadersDefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error al estilizar DataGridView: {ex.Message}");
            }
        }

        private void dataGridView1_CellContentClick(object sender, DataGridViewCellEventArgs e)
        {
            // Evento para clicks en celdas (opcional)
        }

        private void btnExportar_Click(object sender, EventArgs e)
        {
            try
            {
                if (dataGridView1.Rows.Count == 0)
                {
                    MessageBox.Show("No hay datos para exportar", "Información",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                using (SaveFileDialog sfd = new SaveFileDialog())
                {
                    sfd.Filter = "Excel Files (*.xlsx)|*.xlsx|CSV Files (*.csv)|*.csv";
                    sfd.FileName = $"Historial_{DateTime.Now:yyyyMMdd_HHmmss}";

                    if (sfd.ShowDialog() == DialogResult.OK)
                    {
                        // Exportar a CSV (implementación simple)
                        ExportarACSV(sfd.FileName);
                        
                        MessageBox.Show("✅ Archivo exportado exitosamente", "Éxito",
                            MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"❌ Error al exportar:\n{ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void ExportarACSV(string ruta)
        {
            using (var writer = new System.IO.StreamWriter(ruta))
            {
                // Escribir encabezados
                for (int i = 0; i < dataGridView1.Columns.Count; i++)
                {
                    writer.Write(dataGridView1.Columns[i].HeaderText);
                    if (i < dataGridView1.Columns.Count - 1)
                        writer.Write(",");
                }
                writer.WriteLine();

                // Escribir filas
                foreach (DataGridViewRow row in dataGridView1.Rows)
                {
                    for (int i = 0; i < dataGridView1.Columns.Count; i++)
                    {
                        writer.Write(row.Cells[i].Value ?? "");
                        if (i < dataGridView1.Columns.Count - 1)
                            writer.Write(",");
                    }
                    writer.WriteLine();
                }
            }
        }

        private void btnLimpiar_Click(object sender, EventArgs e)
        {
            var resultado = MessageBox.Show(
                "⚠️ ¿Estás seguro de que deseas limpiar todo el historial?\n\n" +
                "Esta acción no se puede deshacer.",
                "Confirmar eliminación",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning);

            if (resultado == DialogResult.Yes)
            {
                try
                {
                    // Aquí iría la lógica para limpiar el historial en BD
                    // Por ahora solo mostramos un mensaje
                    MessageBox.Show("✅ Historial limpiado exitosamente", "Éxito",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);
                    
                    dataGridView1.DataSource = null;
                    lblRegistros.Text = "📋 Registros: 0";
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"❌ Error al limpiar el historial:\n{ex.Message}", "Error",
                        MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void btnCerrar_Click(object sender, EventArgs e)
        {
            this.Close();
        }
    }
}
