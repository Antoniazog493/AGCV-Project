using capaNegocio;
using System;
using System.Windows.Forms;

namespace AGCV
{
    public partial class LogIn : Form
    {
        private readonly CNUsuarios _cnUsuarios = new CNUsuarios();

        public LogIn()
        {
            InitializeComponent();
        }

        private void LogIn_Load(object sender, EventArgs e)
        {
            // Limpiar sesión anterior
            SesionActual.IdUsuario = 0;
            SesionActual.NombreUsuario = string.Empty;

            // Limpiar campos
            txtUsuario.Clear();
            txtContraseña.Clear();
            txtUsuario.Focus();
        }

        private void textBox1_TextChanged(object sender, EventArgs e)
        {
            // Validación en tiempo real (opcional)
        }

        private void textBox2_TextChanged(object sender, EventArgs e)
        {
            // Validación en tiempo real (opcional)
        }

        private void button1_Click(object sender, EventArgs e)
        {
            IntentoLogin();
        }

        private void IntentoLogin()
        {
            // Validaciones previas
            if (string.IsNullOrWhiteSpace(txtUsuario.Text))
            {
                MessageBox.Show("El nombre de usuario es obligatorio", "Validación",
                    MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtUsuario.Focus();
                return;
            }

            if (string.IsNullOrWhiteSpace(txtContraseña.Text))
            {
                MessageBox.Show("La contraseña es obligatoria", "Validación",
                    MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtContraseña.Focus();
                return;
            }

            try
            {
                string usuario = txtUsuario.Text.Trim();
                string clave = txtContraseña.Text.Trim();

                var datosUsuario = _cnUsuarios.Login(usuario, clave);

                if (datosUsuario == null)
                {
                    MessageBox.Show("❌ Usuario o contraseña incorrectos", "Error de Autenticación",
                        MessageBoxButtons.OK, MessageBoxIcon.Error);
                    txtContraseña.Clear();
                    txtContraseña.Focus();
                    return;
                }

                // Guardar usuario en sesión
                SesionActual.IdUsuario = datosUsuario.IdUsuario;
                SesionActual.NombreUsuario = datosUsuario.NombreUsuario;

                // Mostrar mensaje de bienvenida
                MessageBox.Show(
                    $"✅ ¡Bienvenido a AGCV, {datosUsuario.NombreUsuario}!\n\n" +
                    "Sistema de gestión para Joy-Cons de Nintendo Switch",
                    "Sesión Iniciada",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Information);

                // Abrir el menú principal
                HOME menuPrincipal = new HOME();
                menuPrincipal.FormClosed += (s, e) =>
                {
                    // Cuando cierren el HOME, vuelvo a mostrar LOGIN
                    LimpiarFormulario();
                    this.Show();
                };
                menuPrincipal.Show();

                // Ocultar el login (no cerrar)
                this.Hide();
            }
            catch (Exception ex)
            {
                MessageBox.Show(
                    $"❌ Error al iniciar sesión:\n{ex.Message}",
                    "Error",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Error);
            }
        }

        private void linkLabel1_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            // Abrir formulario de crear usuario
            using (var crearUsuario = new CrearUsuario())
            {
                crearUsuario.ShowDialog();
            }
        }

        private void lblOlvidaste_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            MessageBox.Show(
                "Para recuperar tu contraseña, contacta al administrador del sistema.\n\n" +
                "📧 Email: soporte@agcv.com",
                "Recuperar Contraseña",
                MessageBoxButtons.OK,
                MessageBoxIcon.Information);
        }

        private void LimpiarFormulario()
        {
            txtUsuario.Clear();
            txtContraseña.Clear();
            txtUsuario.Focus();
        }

        private void lblDescripcion_Click(object sender, EventArgs e)
        {
        }

        private void lblTitulo_Click(object sender, EventArgs e)
        {
        }
    }
}
